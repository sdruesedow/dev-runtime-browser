!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.identitiesGui=e()}}(function(){return function e(t,n,i){function o(a,d){if(!n[a]){if(!t[a]){var s="function"==typeof require&&require;if(!d&&s)return s(a,!0);if(r)return r(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){var n=t[a][1][e];return o(n?n:e)},l,l.exports,e,t,n,i)}return n[a].exports}for(var r="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}({1:[function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=function(){function e(t){if(i(this,e),!t)throw Error("Identity Module not set!");var n=this,o=t._runtimeURL+"/identity-gui";n._guiURL=o,n.identityModule=t,n._messageBus=t.messageBus,n.identityModule.deployGUI(),n.resultUrL=void 0,n._messageBus.addListener(o,function(e){var t=(e.body.value,void 0);document.getElementsByTagName("body")[0].style="background-color:white;",parent.postMessage({body:{method:"showAdminPage"},to:"runtime:gui-manager"},"*"),$(".admin-page").removeClass("hide"),n.showIdentitiesGUI(e.body.value).then(function(i){var o=void 0;switch(parent.postMessage({body:{method:"hideAdminPage"},to:"runtime:gui-manager"},"*"),$(".admin-page").addClass("hide"),document.getElementsByTagName("body")[0].style="background-color:transparent",$(".identities-section").addClass("hide"),$(".policies-section").addClass("hide"),i.type){case"idp":t={type:"idp",value:i.value,code:200},o={id:e.id,type:"response",to:e.from,from:e.to,body:t},n._messageBus.postMessage(o);break;case"identity":t={type:"identity",value:i.value,code:200},o={id:e.id,type:"response",to:e.from,from:e.to,body:t},n._messageBus.postMessage(o);break;default:t={type:"error",value:"Error on identity GUI",code:400},o={id:e.id,type:"response",to:e.from,from:e.to,body:t},n._messageBus.postMessage(o)}})}),$(".identities-page-show").on("click",function(){n.showIdentitiesGUI()})}return o(e,[{key:"showIdentitiesGUI",value:function(e){var t=this;return new Promise(function(n,i){var o=void 0,r=void 0;e?(o=e,r=!1):(r=!0,o=t.identityModule.getIdentitiesToChoose()),$(".policies-section").addClass("hide"),$(".identities-section").removeClass("hide"),t.showMyIdentities(o.identities,r).then(function(e){console.log("chosen identity: ",e),n({type:"identity",value:e})});var a=function(e){console.log("chosen identity: ",e),n({type:"identity",value:e})},d=o.idps;$("#idproviders").html(t._getList(d)),$("#idproviders").off(),$("#idproviders").on("click",function(e){return t.obtainNewIdentity(a,r)}),$(".identities-reset").off(),$(".identities-reset").on("click",function(e){return t._resetIdentities(a)})})}},{key:"showMyIdentities",value:function(e,t){var n=this;return new Promise(function(i,o){var r=[];for(var a in e){var d=e[a].split("@");r.push({email:e[a],domain:d[1]})}var s=document.getElementById("my-ids");s.innerHTML="";for(var u=n.createTable(),l=document.createElement("tbody"),c=r.length,f=0;f<c;f++){var p=n.createTableRow(r[f],t);l.appendChild(p)}u.appendChild(l),s.appendChild(u);var v=function(e){i(e)};t||$(".clickable-cell").on("click",function(e){return n.changeID(v)}),$(".remove-id").on("click",function(t){return n.removeID(e)})})}},{key:"createTable",value:function(){var e=document.createElement("table");e.className="centered";var t=document.createElement("thead"),n=document.createElement("tr"),i=document.createElement("th");return i.textContent="Email",n.appendChild(i),t.appendChild(n),e.appendChild(t),e}},{key:"createTableRow",value:function(e,t){var n=document.createElement("tr"),i=document.createElement("td");if(i.textContent=e.email,i.className="clickable-cell",i.style="cursor: pointer",n.appendChild(i),i=document.createElement("td"),t){var o=document.createElement("button");o.textContent="Remove",o.className="remove-id waves-effect waves-light btn",i.appendChild(o)}return n.appendChild(i),n}},{key:"changeID",value:function(e){var t=event.target.innerText;if("settings"!==t)return e(t),t}},{key:"removeID",value:function(e){var t=this,n=event.target.parentNode.parentNode,i=n.children[0].textContent;n.children[1].textContent;t.identityModule.unregisterIdentity(i);for(var o=e.length,r=0;r<o;r++)if(e[r].email===i){e.splice(r,1);break}t.showMyIdentities(e,!0)}},{key:"obtainNewIdentity",value:function(e,t){var n=this,i=event.target.textContent;event.target.text;n.identityModule.crypto.generateRSAKeyPair().then(function(t){var o=btoa(t["public"]);n.identityModule.sendGenerateMessage(o,"origin",void 0,i).then(function(r){console.log("receivedURL: "+r.loginUrl.substring(0,20)+"..."),n.resultUrL=r.loginUrl,$(".login-idp").html("<p>Chosen IDP: "+i+"</p>"),$(".login").removeClass("hide"),$(".login-btn").off(),$(".login-btn").on("click",function(a){$(".login").addClass("hide"),n._authenticateUser(t,o,r,"origin",i).then(function(t){e(t),n.showIdentitiesGUI()})})})})}},{key:"_getList",value:function(e){for(var t="",n=e.length,i=0;i<n;i++)t+='<li class="divider"></li>',t+='<li><a class="center-align">'+e[i]+"</a></li>";return t}},{key:"_authenticateUser",value:function(e,t,n,i,o){var r=this,a=r.resultUrL;return new Promise(function(n,d){r.identityModule.openPopup(a).then(function(a){r.identityModule.sendGenerateMessage(t,i,a,o).then(function(t){t?r.identityModule.storeIdentity(t,e).then(function(e){n(e.userProfile.username)},function(e){d(e)}):d("error on obtaining identity information")})},function(e){d(e)})})}},{key:"_resetIdentities",value:function(){console.log("_resetIdentities")}}]),e}();n["default"]=r},{}]},{},[1])(1)});
//# sourceMappingURL=identities-gui.js.map
